<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="运维笔记" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="个人运维笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="运维笔记">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;page&#x2F;7&#x2F;index.html">
<meta property="og:site_name" content="运维笔记">
<meta property="og:description" content="个人运维笔记">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>运维笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">运维笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">56</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">47</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">77</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/k8s/gluster-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/k8s/gluster-k8s/" class="post-title-link" itemprop="url">k8s/gluster-k8s</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-11 17:41:30" itemprop="dateModified" datetime="2019-09-11T17:41:30+08:00">2019-09-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://www.cnblogs.com/yourarebest/p/9629521.html" target="_blank" rel="noopener">https://www.cnblogs.com/yourarebest/p/9629521.html</a></p>
<h3 id="静态手动管理glusterfs"><a href="#静态手动管理glusterfs" class="headerlink" title="静态手动管理glusterfs"></a>静态手动管理glusterfs</h3><h4 id="手动创建pvc-这种方式提示手动创建storageclass，但是只有动态创建的storageclass"><a href="#手动创建pvc-这种方式提示手动创建storageclass，但是只有动态创建的storageclass" class="headerlink" title="手动创建pvc,这种方式提示手动创建storageclass，但是只有动态创建的storageclass"></a>手动创建pvc,这种方式提示手动创建storageclass，但是只有动态创建的storageclass</h4><ol>
<li>创建GlusterFS卷</li>
<li>Kubernetes创建PV等存储:gfs-svc gfs-ep gfs-pv </li>
<li>Kubernetes创建应用 gfs-pvc pod<blockquote>
<p>这种方式是手动管理volume。假设在k8s上部署一个使用gluster存储的应用，如果使用之前应用的volume，能看到其他应用的数据，多个应用之间的数据应该是隔离的，也就是权限问题，同时，大概率导致文件命名冲突问题。pv(c)中设置的容量capacity也无法控制。基本上处于不可用。 <a href="http://rdc.hundsun.com/portal/article/826.html" target="_blank" rel="noopener">http://rdc.hundsun.com/portal/article/826.html</a></p>
</blockquote>
</li>
</ol>
<h4 id="通过”endpoints”-“glusterfs-cluster”-path”-“gv0”"><a href="#通过”endpoints”-“glusterfs-cluster”-path”-“gv0”" class="headerlink" title="通过”endpoints”: “glusterfs-cluster”,path”: “gv0”,"></a>通过”endpoints”: “glusterfs-cluster”,path”: “gv0”,</h4><p><a href="https://github.com/kubernetes/examples/blob/master/staging/volumes/glusterfs/glusterfs-pod.json" target="_blank" rel="noopener">https://github.com/kubernetes/examples/blob/master/staging/volumes/glusterfs/glusterfs-pod.json</a></p>
<h4 id="直接通过-brickrootPaths-“172-16-2-131-tmp-172-16-2-132-tmp”‘"><a href="#直接通过-brickrootPaths-“172-16-2-131-tmp-172-16-2-132-tmp”‘" class="headerlink" title="直接通过 brickrootPaths: “172.16.2.131:/tmp/,172.16.2.132:/tmp”‘"></a>直接通过 brickrootPaths: “172.16.2.131:/tmp/,172.16.2.132:/tmp”‘</h4><p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/gluster/glusterfs" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/external-storage/tree/master/gluster/glusterfs</a></p>
<h3 id="通过heketi来动态管理glusterfs"><a href="#通过heketi来动态管理glusterfs" class="headerlink" title="通过heketi来动态管理glusterfs"></a>通过heketi来动态管理glusterfs</h3><h3 id="gluster"><a href="#gluster" class="headerlink" title="gluster"></a>gluster</h3><p><a href="https://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md" target="_blank" rel="noopener">https://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">modprobe dm_snapshot</span><br><span class="line">modprobe dm_mirror</span><br><span class="line">modprobe dm_thin_pool</span><br><span class="line"></span><br><span class="line">sudo wipefs -af /dev/sdb</span><br><span class="line">dmsetup ls</span><br><span class="line">dmsetup remove ddf1_44656c6c202020201000007910281f1747cd0dedccd25148</span><br><span class="line">dmsetup remove_all</span><br><span class="line">./gk-deploy -g --abort</span><br><span class="line"></span><br><span class="line">./gk-deploy -gv --single-node</span><br></pre></td></tr></table></figure>
<h3 id="heketi"><a href="#heketi" class="headerlink" title="heketi"></a>heketi</h3><p>/bin/kubectl -n default exec -i heketi-85dbbbb55-78df9 – heketi-cli -s <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> –user admin –secret ‘’ volume list</p>
<h3 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h3><p><a href="https://www.jianshu.com/p/99e610067bc8" target="_blank" rel="noopener">https://www.jianshu.com/p/99e610067bc8</a><br>storageclass <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p>
<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><p>mount -t glusterfs 10.105.94.239:vol_fef6bc590cb2a3c8c1df0d72e91a5146 /gfs-promotion/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行kubectl get pv pvc-bd0960f3-7881-11e9-a9d4-c81f66c0e5c3 -o yaml获得</span><br><span class="line">1. spec.glusterfs.path: vol_fef6bc590cb2a3c8c1df0d72e91a5146</span><br><span class="line">2. spec.glusterfs.endpoints: 10.105.94.239</span><br></pre></td></tr></table></figure>

<h2 id="pv挂载"><a href="#pv挂载" class="headerlink" title="pv挂载"></a>pv挂载</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">- name: cache-volume</span><br><span class="line">  emptyDir: &#123;&#125;</span><br><span class="line">- name: test-volume</span><br><span class="line">  hostPath:</span><br><span class="line">    # directory location on host</span><br><span class="line">    path: /data</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/k8s/issues/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/k8s/issues/" class="post-title-link" itemprop="url">k8s/issues</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-27 16:46:35" itemprop="dateModified" datetime="2019-11-27T16:46:35+08:00">2019-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="kubernetes部署失败"><a href="#kubernetes部署失败" class="headerlink" title="kubernetes部署失败"></a>kubernetes部署失败</h3><ul>
<li><p>重置etcd和kubernetes，然后再部署一边etcd和kubernetes</p>
<p>kubeadm reset -f &amp;&amp; kubeadm init –config /var/tmp/wise2c/kubernetes/kubeadm.conf</p>
</li>
</ul>
<p>然后把第一台的这个kubeadm.conf文件拷贝到master02和03，执行同样命</p>
<p>查看证书 </p>
<p>cfssl-certinfo /etc/kubernetes/pki/apiserver.crt</p>
<ul>
<li>可能系统原有的包冲突</li>
</ul>
<p>libsepol-devel-2.5-6.el7.x86_64<br>libselinux-devel-2.5-11.el7.x86_64</p>
<ul>
<li>双网卡导致安装初始化失败</li>
</ul>
<p>ifdown em1</p>
<p>route add default gw 10.0.0.174</p>
<p>两台work节点因为harbor的域名没有解析而加入集群失败，notReady</p>
<h4 id="进入容器用root用户"><a href="#进入容器用root用户" class="headerlink" title="进入容器用root用户"></a>进入容器用root用户</h4><p> docker exec -ti -u root 848669a8722b bash</p>
<h4 id="root-master02-harbor-kubectl-get-nodes"><a href="#root-master02-harbor-kubectl-get-nodes" class="headerlink" title="[root@master02 harbor]# kubectl get nodes"></a>[root@master02 harbor]# kubectl get nodes</h4><p>The connection to the server localhost:8080 was refused - did you specify the right host or port?<br>解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line"></span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="harbor"><a href="#harbor" class="headerlink" title="harbor"></a>harbor</h3><ul>
<li>Error response from daemon: Get https:/ getsockopt: connection refused<br>新版本docker是在/etc/docker/daemon.json上修改insecure-registries参数，旧版本直接改动启动命令</li>
</ul>
<h3 id="集群内部域名"><a href="#集群内部域名" class="headerlink" title="集群内部域名"></a>集群内部域名</h3><p> kubernetes.default.svc.cluster.local </p>
<h4 id="强制删除pod"><a href="#强制删除pod" class="headerlink" title="强制删除pod"></a>强制删除pod</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">方法1</span><br><span class="line"># 删除POD</span><br><span class="line">kubectl delete pod PODNAME --force --grace-period=0</span><br><span class="line"># 删除NAMESPACE</span><br><span class="line">kubectl delete namespace NAMESPACENAME --force --grace-period=0</span><br><span class="line">方法2</span><br><span class="line"># 删除default namespace下的pod名为pod-to-be-deleted-0</span><br><span class="line">ETCDCTL_API=3 etcdctl del /registry/pods/default/pod-to-be-deleted-0</span><br><span class="line"># 删除需要删除的NAMESPACE</span><br><span class="line">etcdctl del /registry/namespaces/NAMESPACENAME</span><br></pre></td></tr></table></figure>

<h3 id="prometheus-k8s-0-alertmanager-main-0-两个pod启动问题"><a href="#prometheus-k8s-0-alertmanager-main-0-两个pod启动问题" class="headerlink" title="prometheus-k8s-0  alertmanager-main-0 两个pod启动问题"></a>prometheus-k8s-0  alertmanager-main-0 两个pod启动问题</h3><p><a href="https://github.com/coreos/prometheus-operator/issues/2409" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator/issues/2409</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">升级镜像版本到v0.29.0</span><br><span class="line">        image: quay.io/coreos/prometheus-operator:v0.29.0</span><br><span class="line">        - --prometheus-config-reloader=quay.io/coreos/prometheus-config-reloader:v0.29.0</span><br></pre></td></tr></table></figure>

<h3 id="匿名授权"><a href="#匿名授权" class="headerlink" title="匿名授权"></a>匿名授权</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding system:anonymous   --clusterrole=cluster-admin   --user=system:anonymous</span><br></pre></td></tr></table></figure>

<h3 id="删除了所有该Namespace资源之后使用kubectl-delete-namespace-test发现删除不掉，一直卡在Terminating状态，使用–force参数依然无法删除"><a href="#删除了所有该Namespace资源之后使用kubectl-delete-namespace-test发现删除不掉，一直卡在Terminating状态，使用–force参数依然无法删除" class="headerlink" title="删除了所有该Namespace资源之后使用kubectl delete namespace test发现删除不掉，一直卡在Terminating状态，使用–force参数依然无法删除"></a>删除了所有该Namespace资源之后使用kubectl delete namespace test发现删除不掉，一直卡在Terminating状态，使用–force参数依然无法删除</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">先运行kubectl get namespace test -o json &gt; tmp.json，拿到当前namespace描述，然后打开tmp.json，删除其中的spec字段。因为这边的K8s集群是带认证的，用非认证端口</span><br><span class="line">curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @tmp.json http://127.0.0.1:8080/api/v1/namespaces/monitoring/finalize</span><br></pre></td></tr></table></figure>


<h3 id="pod启动时候-提示docker没有登录，而节点docker是用root登录成功，并可以手动拉取镜像的"><a href="#pod启动时候-提示docker没有登录，而节点docker是用root登录成功，并可以手动拉取镜像的" class="headerlink" title="pod启动时候 提示docker没有登录，而节点docker是用root登录成功，并可以手动拉取镜像的"></a>pod启动时候 提示docker没有登录，而节点docker是用root登录成功，并可以手动拉取镜像的</h3><p>Failed to pull image “hub.4399doc.com/adgame-snapshot/adplan-search:1.0.35-SNAPSHOT”: rpc error: code = Unknown desc = Error response from daemon: pull access denied for hub.4399doc.com/adgame-snapshot/adplan-search, repository does not exist or may require ‘docker login’</p>
<p>可把登录的配置信息拷贝到/var/lib/kubelet/config.json，重启kubelet</p>
<h3 id="kubectl-logs-dial-tcp-10250-connect-connection-timed-out"><a href="#kubectl-logs-dial-tcp-10250-connect-connection-timed-out" class="headerlink" title="kubectl logs dial tcp :10250: connect: connection timed out"></a>kubectl logs dial tcp :10250: connect: connection timed out</h3><p>无法kubectl exec log 到该节点的pod<br>查看kubectl get node -o wide 是否以主机名为节点名，主机名是否映射到内网ip，如果不是需要加hosts，并重启kubelet</p>
<h3 id="213master节点重启后，kubeadm-reset导致calico注册不到etcd"><a href="#213master节点重启后，kubeadm-reset导致calico注册不到etcd" class="headerlink" title="213master节点重启后，kubeadm reset导致calico注册不到etcd"></a>213master节点重启后，kubeadm reset导致calico注册不到etcd</h3><p>需先在etcd集群删除原有的213节点</p>
<h3 id="dashboard-登录"><a href="#dashboard-登录" class="headerlink" title="dashboard 登录"></a>dashboard 登录</h3><p><a href="https://github.com/kubernetes/dashboard/blob/master/README.md#getting-started" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/blob/master/README.md#getting-started</a>  安装文档<br>Incoming HTTP/1.1 POST /api/v1/login request from 10.244.0.0:42696: { contents hidden }<br><a href="https://github.com/kubernetes/dashboard/issues/3464" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/issues/3464</a><br>改用https登录即可<br><code>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</code></p>
<h3 id="境外镜像拉取不到"><a href="#境外镜像拉取不到" class="headerlink" title="境外镜像拉取不到"></a>境外镜像拉取不到</h3><ul>
<li>拉取镜像,从k8s.grc.io仓库中拉取所需镜像文件，但由于G-F-W导致无法正常拉取，本文将介绍如何绕过此问题，来完成业务的部署。docker.io仓库对google的容器做了镜像，可以通过下列命令下拉取相关镜像<br>k8s.gcr.io/elasticsearch:v6.2.5  改为下面<br>docker pull mirrorgooglecontainers/elasticsearch:v6.2.5</li>
</ul>
<h3 id="ipip换gpr，需清除缓存-var-lib-cni"><a href="#ipip换gpr，需清除缓存-var-lib-cni" class="headerlink" title="ipip换gpr，需清除缓存/var/lib/cni"></a>ipip换gpr，需清除缓存/var/lib/cni</h3><h3 id="pv-retain-恢复"><a href="#pv-retain-恢复" class="headerlink" title="pv retain 恢复"></a>pv retain 恢复</h3><p>删除pv的spec.claimRef，状态会变成available，再apply pvc即可<a href="https://blog.csdn.net/ygqygq2/article/details/83350983" target="_blank" rel="noopener">https://blog.csdn.net/ygqygq2/article/details/83350983</a></p>
<h3 id="Can’t-open-dev-sdb-exclusively-Mounted-filesystem"><a href="#Can’t-open-dev-sdb-exclusively-Mounted-filesystem" class="headerlink" title="Can’t open /dev/sdb exclusively. Mounted filesystem?"></a>Can’t open /dev/sdb exclusively. Mounted filesystem?</h3><p>a: heketi只管理没有文件系统的裸盘，如果你的机器上的磁盘的文件系统是xfs或者是ext4，可以执行pvcreate –metadatasize=128M –dataalignment=256K /dev/sdb将磁盘格式化成LVM2形式，那么就没问题了，这个问题困扰了我好久</p>
<h3 id="heketi-troubleshooting-https-github-com-heketi-heketi-blob-master-docs-troubleshooting-md"><a href="#heketi-troubleshooting-https-github-com-heketi-heketi-blob-master-docs-troubleshooting-md" class="headerlink" title="heketi troubleshooting https://github.com/heketi/heketi/blob/master/docs/troubleshooting.md"></a>heketi troubleshooting <a href="https://github.com/heketi/heketi/blob/master/docs/troubleshooting.md" target="_blank" rel="noopener">https://github.com/heketi/heketi/blob/master/docs/troubleshooting.md</a></h3><h3 id="helm-prometheus-operator"><a href="#helm-prometheus-operator" class="headerlink" title="helm prometheus-operator"></a>helm prometheus-operator</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/example/prometheus-operator-crd/alertmanager.crd.yaml</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/example/prometheus-operator-crd/prometheus.crd.yaml</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/example/prometheus-operator-crd/prometheusrule.crd.yaml</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/master/example/prometheus-operator-crd/servicemonitor.crd.yaml</span><br></pre></td></tr></table></figure>

<h3 id="内存设置"><a href="#内存设置" class="headerlink" title="内存设置"></a>内存设置</h3><p>所以猜测在设置jvm启动参数的时候 -Xmx的这个值一般要小于docker限制内存数，个人觉得  -Xmx:docker的比例为 4/5 - 3/4，</p>
<h3 id="dns解析错误"><a href="#dns解析错误" class="headerlink" title="dns解析错误"></a>dns解析错误</h3><p>apt-get install dnsutils</p>
<h2 id="v1-11"><a href="#v1-11" class="headerlink" title="v1.11"></a>v1.11</h2><h3 id="skipping-pod-synchronization-PLEG-is-not-healthy-pleg-was-last-seen-active-2562047h47m16-854775807s-ago-threshold-is-3m0s"><a href="#skipping-pod-synchronization-PLEG-is-not-healthy-pleg-was-last-seen-active-2562047h47m16-854775807s-ago-threshold-is-3m0s" class="headerlink" title="skipping pod synchronization - [PLEG is not healthy: pleg was last seen active 2562047h47m16.854775807s ago; threshold is 3m0s]"></a>skipping pod synchronization - [PLEG is not healthy: pleg was last seen active 2562047h47m16.854775807s ago; threshold is 3m0s]</h3><p><a href="https://github.com/kubernetes/kubernetes/issues/45419" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/45419</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pleg is for kubelet to periodically list pods in the node to check healthy and update cache. If you see pleg timeout log, it may not be related to dns, but because kubelet&apos;s call to docker is timeout.</span><br><span class="line">pleg is the short for &quot;pod lifecycle event generator&quot;, it is an internal component of kubelet and i do not think you can directly check its status</span><br><span class="line">I don&apos;t think this is a K8s/OKD problem, I think this is a &quot;some resource on your node is being locked by something which is causing processes to pile up waiting for CPU time and that&apos;s breaking everything&quot; problem.</span><br><span class="line">https://chanjarster.github.io/post/kublet-pleg-not-healthy/</span><br><span class="line"></span><br><span class="line">执行docker ps ;systemctl status -l docker看看 更像是docker本身的问题</span><br></pre></td></tr></table></figure>

<h3 id="7月-30-11-29-53-node1214-dockerd-8959-time-”2019-07-30T11-29-53-72335999-08-00”-level-error-msg-”containerd-start-container”-error-”oci-runtime-error-container-linux-go-262-starting-container-process-caused-quot-process-linux-go-339-container-init-caused-quot-quot-quot-n”-id-f39bdcbcd5b57c6fad86f625cfe5fa70740f095b5e49aa221cfb6c165034c43f"><a href="#7月-30-11-29-53-node1214-dockerd-8959-time-”2019-07-30T11-29-53-72335999-08-00”-level-error-msg-”containerd-start-container”-error-”oci-runtime-error-container-linux-go-262-starting-container-process-caused-quot-process-linux-go-339-container-init-caused-quot-quot-quot-n”-id-f39bdcbcd5b57c6fad86f625cfe5fa70740f095b5e49aa221cfb6c165034c43f" class="headerlink" title="7月 30 11:29:53 node1214 dockerd[8959]: time=”2019-07-30T11:29:53.72335999+08:00” level=error msg=”containerd: start container” error=”oci runtime error: container_linux.go:262: starting container process caused &quot;process_linux.go:339: container init caused \&quot;\&quot;&quot;\n” id=f39bdcbcd5b57c6fad86f625cfe5fa70740f095b5e49aa221cfb6c165034c43f"></a>7月 30 11:29:53 node1214 dockerd[8959]: time=”2019-07-30T11:29:53.72335999+08:00” level=error msg=”containerd: start container” error=”oci runtime error: container_linux.go:262: starting container process caused &quot;process_linux.go:339: container init caused \&quot;\&quot;&quot;\n” id=f39bdcbcd5b57c6fad86f625cfe5fa70740f095b5e49aa221cfb6c165034c43f</h3><p>重启机器</p>
<p>imagename = ‘registry-vpc.cn-beijing.aliyuncs.com/{}/{}-{}:’.format(‘jiaxiang’, “@option.namespace@”, “@option.image_name@”)<br>/usr/local/src/k8s/buyu2/</p>
<h3 id="docker-ps卡住"><a href="#docker-ps卡住" class="headerlink" title="docker ps卡住"></a>docker ps卡住</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">引用/proc/sys/vm/drop_caches (since Linux 2.6.16)</span><br><span class="line">Writing to this file causes the kernel to drop clean caches,dentries and inodes from memory, causing that memory to become free.</span><br><span class="line">To free pagecache, use</span><br><span class="line"> echo 1 &gt; /proc/sys/vm/drop_caches;</span><br><span class="line"> to free dentries and inodes, use</span><br><span class="line">echo 2 &gt; /proc/sys/vm/drop_caches;</span><br><span class="line">to free pagecache, dentries and inodes, use</span><br><span class="line"> echo 3 &gt;/proc/sys/vm/drop_caches.</span><br><span class="line"> 设置/proc/sys/vm/min_free_kbytes的值为4G bytes</span><br><span class="line">echo 4194304 &gt; /proc/sys/vm/min_free_kbytes</span><br><span class="line">cat /proc/buddyinfo</span><br></pre></td></tr></table></figure>

<h2 id="镜像清理"><a href="#镜像清理" class="headerlink" title="镜像清理"></a>镜像清理</h2><p>docker system prune后可以加额外的参数，如：<br>docker system prune -a ： 一并清除所有未被使用的镜像和悬空镜像。<br>docker system prune -f ： 用以强制删除，不提示信息。</p>
<h4 id="spring-cloud-gateway-and-zuul"><a href="#spring-cloud-gateway-and-zuul" class="headerlink" title="spring cloud gateway and zuul"></a>spring cloud gateway and zuul</h4><p><a href="http://www.springcloud.cn/" target="_blank" rel="noopener">http://www.springcloud.cn/</a></p>
<p><a href="http://www.cnblogs.com/qnloft/p/qing-ning-kai-cheSpring-Cloud-liu--Spring-Cloud-Ga.html" target="_blank" rel="noopener">http://www.cnblogs.com/qnloft/p/qing-ning-kai-cheSpring-Cloud-liu--Spring-Cloud-Ga.html</a></p>
<p><a href="https://blog.csdn.net/yalishadaa/article/details/79400916" target="_blank" rel="noopener">https://blog.csdn.net/yalishadaa/article/details/79400916</a><br><a href="https://springcloud.cc/" target="_blank" rel="noopener">https://springcloud.cc/</a><br>websocket 设置<a href="http://springcloud.cn/view/36" target="_blank" rel="noopener">http://springcloud.cn/view/36</a><br><a href="https://xujin.org/sc/gw/gw05/" target="_blank" rel="noopener">https://xujin.org/sc/gw/gw05/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/k8s/kubeadm-k8s%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/k8s/kubeadm-k8s%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">k8s/kubeadm-k8s安装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-27 16:42:20" itemprop="dateModified" datetime="2019-11-27T16:42:20+08:00">2019-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>dashboard 访问 <a href="https://www.cnblogs.com/linuxk/p/9783510.html" target="_blank" rel="noopener">https://www.cnblogs.com/linuxk/p/9783510.html</a></p>
<p>教程 <a href="https://www.kubernetes.org.cn/5213.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/5213.html</a></p>
<h3 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h3><p>rpm -Uvh *.rpm</p>
<h3 id="查看当前内核"><a href="#查看当前内核" class="headerlink" title="查看当前内核"></a>查看当前内核</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">awk -F\&apos; &apos;$1==&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&apos; /etc/grub2.cfg</span><br><span class="line">grub2-editenv list</span><br><span class="line"></span><br><span class="line">grub2-set-default 0</span><br><span class="line">grub2-set-default &apos;CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)&apos;</span><br></pre></td></tr></table></figure>

<h3 id="加节点"><a href="#加节点" class="headerlink" title="加节点"></a>加节点</h3><ol>
<li>添加从master到node的ssh免密码登录</li>
<li>设置hostname，hostnamectl set-hostname，加下hosts</li>
<li>拷贝k8s-v1.14.0/目录到node上，并执行init-node.sh</li>
<li>在master上执行sh joib-node.sh ${nodeip}</li>
<li>kubectl get pods -n kube-system</li>
<li>命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node $&#123;node&#125; env=pro &amp;&amp; kubectl label node $&#123;node&#125; beta.kubernetes.io/fluentd-ds-ready=true &amp;&amp; kubectl label node $&#123;node&#125; cpu=high</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="其他文档"><a href="#其他文档" class="headerlink" title="其他文档"></a>其他文档</h3><p><a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="noopener">https://github.com/opsnull/follow-me-install-kubernetes-cluster</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/db/etcd/etcd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/db/etcd/etcd/" class="post-title-link" itemprop="url">db/etcd/etcd</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-22 16:42:03" itemprop="dateModified" datetime="2019-11-22T16:42:03+08:00">2019-11-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>github下载二进制包<br>拷贝二进制etcd,etcdctl文件到/usr/local/bin下<br>分别3个创建配置文件/etc/etcd/etcd.yml<br>v3 v2区别<a href="https://blog.csdn.net/kozazyh/article/details/79586530" target="_blank" rel="noopener">https://blog.csdn.net/kozazyh/article/details/79586530</a><br>备份恢复参考<a href="https://blog.csdn.net/ygqygq2/article/details/82753840" target="_blank" rel="noopener">https://blog.csdn.net/ygqygq2/article/details/82753840</a></p>
<h2 id="管理界面https-github-com-kopeio-etcd-manager"><a href="#管理界面https-github-com-kopeio-etcd-manager" class="headerlink" title="管理界面https://github.com/kopeio/etcd-manager"></a>管理界面<a href="https://github.com/kopeio/etcd-manager" target="_blank" rel="noopener">https://github.com/kopeio/etcd-manager</a></h2><p>要在在该管理界面显示目录需单独创建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">name: etcd-3</span><br><span class="line">data-dir: /data/etcd</span><br><span class="line">listen-client-urls: http://192.168.62.140:2379,http://127.0.0.1:2379</span><br><span class="line">advertise-client-urls: http://192.168.62.140:2379,http://127.0.0.1:2379</span><br><span class="line">listen-peer-urls: http://192.168.62.140:2380</span><br><span class="line">initial-advertise-peer-urls: http://192.168.62.140:2380</span><br><span class="line">initial-cluster: etcd-1=http://192.168.62.210:2380,etcd-2=http://192.168.62.154:2380,etcd-3=http://192.168.62.140:2380</span><br><span class="line">initial-cluster-token: etcd-cluster-token</span><br><span class="line">initial-cluster-state: new</span><br></pre></td></tr></table></figure>
<p>分别执行：etcd –config-file=/etc/etcd/etcd.yml &amp;</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">列出成员节点</span><br><span class="line">etcdctl member list</span><br><span class="line">检查集群健康状态</span><br><span class="line">etcdctl cluster-health</span><br><span class="line">./etcdctl \</span><br><span class="line">--ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">--cert-file=/etc/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/etc/etcd/ssl/server-key.pem \</span><br><span class="line">--endpoints=&quot;https://172.16.8.100:2379,\</span><br><span class="line">https://172.16.8.101:2379,\</span><br><span class="line">https://172.16.8.102:2379&quot; cluster-health</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=&apos;https://127.0.0.1:2379&apos; --ca-file=ca.crt --cert-file=server.crt --key-file=server.key ls /</span><br><span class="line"></span><br><span class="line">[root@node119 prometheus]# kubectl -n kube-system exec -it etcd-node119 -- sh</span><br><span class="line">/ # cd /etc/kubernetes/pki/etcd/</span><br><span class="line">export ETCDCTL_API=3; etcdctl --endpoints=&apos;https://127.0.0.1:23</span><br><span class="line">79&apos; --cacert=&quot;ca.crt&quot; --cert=&quot;server.crt&quot; --key=&quot;server.key&quot; get / --prefix --keys-only</span><br><span class="line"></span><br><span class="line">或者直接在节点运行,需拷贝etcdctl到节点上</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=&apos;https://127.0.0.1:2379&apos; --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key get / --prefix --keys-only</span><br><span class="line">创建目录：</span><br><span class="line">/usr/local/etcd-v3.2.26-linux-amd64/bin/etcdctl --endpoints=$ENDPOINTS put /test3 &apos;etcdv3_dir_$2H#%gRe3*t&apos;</span><br></pre></td></tr></table></figure>

<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><p><a href="https://github.com/etcd-io/etcd/blob/master/Documentation/metrics.md" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/blob/master/Documentation/metrics.md</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/%E5%85%B6%E4%BB%96/apollo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/%E5%85%B6%E4%BB%96/apollo/" class="post-title-link" itemprop="url">其他/apollo</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="apollo"><a href="#apollo" class="headerlink" title="apollo"></a>apollo</h2><p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo</a></p>
<p>portal通过admin来管理config所以要给portal开通每个admin的8090端口</p>
<p>升级账户管理</p>
<p><a href="https://github.com/ctripcorp/apollo/wiki/Portal-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo/wiki/Portal-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD</a></p>
<h3 id="新增uat环境，"><a href="#新增uat环境，" class="headerlink" title="新增uat环境，"></a>新增uat环境，</h3><h4 id="建立数据库uatApolloConfigDB"><a href="#建立数据库uatApolloConfigDB" class="headerlink" title="建立数据库uatApolloConfigDB"></a>建立数据库uatApolloConfigDB</h4><ul>
<li>更改uat-apolloconfigdb.sql:</li>
</ul>
<p>`CREATE DATABASE IF NOT EXISTS uatApolloConfigDB DEFAULT CHARACTER SET = utf8mb4;</p>
<p>Use uatApolloConfigDB;`</p>
<p><code>ServerConfig       (&#39;eureka.service.url&#39;, &#39;default&#39;, &#39;http://42.62.2.211:8080/eureka/&#39;, &#39;Eureka服务Url，多个service以英文逗号分隔&#39;),</code></p>
<ul>
<li>导入数据：</li>
</ul>
<p><code>/usr/local/mysql/bin/mysql -uroot -p</code>cat /etc/savep <code>uatApolloConfigDB &lt; ./uat-apolloconfigdb.sql</code></p>
<ul>
<li>创建apollo账户</li>
</ul>
<p><code>grant all privileges on uatApolloConfigDB.* to &#39;apollo&#39;@&#39;10.0.0.211&#39;;</code></p>
<h4 id="更改构建脚本uat-build-sh"><a href="#更改构建脚本uat-build-sh" class="headerlink" title="更改构建脚本uat-build.sh"></a>更改构建脚本uat-build.sh</h4><p>apollo_config_db_url=jdbc:mysql://10.0.0.198:3306/uatApolloConfigDB?characterEncoding=utf8</p>
<h3 id="访问feed项目的本地配置"><a href="#访问feed项目的本地配置" class="headerlink" title="访问feed项目的本地配置"></a>访问feed项目的本地配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.0.0.218:8080/configs/feed/default/application?ip=10.0.0.213</span><br></pre></td></tr></table></figure>
<h3 id="删除应用"><a href="#删除应用" class="headerlink" title="删除应用"></a>删除应用</h3><p><a href="https://github.com/ctripcorp/apollo/wiki/%E9%83%A8%E7%BD%B2&amp;%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98#51-%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4%E5%BA%94%E7%94%A8" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo/wiki/%E9%83%A8%E7%BD%B2&amp;%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98#51-%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4%E5%BA%94%E7%94%A8</a></p>
<h3 id="apollo-client部署到仓库"><a href="#apollo-client部署到仓库" class="headerlink" title="apollo client部署到仓库"></a>apollo client部署到仓库</h3><p>应该是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean deploy -DskipTests -pl apollo-client -am $META_SERVERS_OPTS</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/monitor/skywalking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/monitor/skywalking/" class="post-title-link" itemprop="url">monitor/skywalking</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="配置文档"><a href="#配置文档" class="headerlink" title="配置文档"></a>配置文档</h3><p><a href="https://github.com/apache/incubator-skywalking/tree/master/docs/en/setup" target="_blank" rel="noopener">https://github.com/apache/incubator-skywalking/tree/master/docs/en/setup</a></p>
<p>集群模式：1个webserver，2个collector，1个es集群（目前有3个节点），zookeeper（三个节点），每个应用配套一个agent，</p>
<h3 id="增加过滤插件"><a href="#增加过滤插件" class="headerlink" title="增加过滤插件"></a>增加过滤插件</h3><p><a href="https://github.com/apache/incubator-skywalking/blob/5.x/apm-sniffer/optional-plugins/trace-ignore-plugin/README_CN.md" target="_blank" rel="noopener">https://github.com/apache/incubator-skywalking/blob/5.x/apm-sniffer/optional-plugins/trace-ignore-plugin/README_CN.md</a></p>
<h3 id="需要注意的是"><a href="#需要注意的是" class="headerlink" title="需要注意的是"></a>需要注意的是</h3><ol>
<li><p>不同版本的数据格式可能不一样，当升级版本时需要清除之前的数据。</p>
</li>
<li><p>注意两个配置文件collector的application.yml和agent的agent.config，collector的监听ip是根据hostname的ip指向来确定(application.yml中配置为host: 0.0.0.0的除外)</p>
</li>
<li><p>应用端tomcat或者jetty版本也有要求，线上用jetty9版本，在启动脚本加入”-javaagent:$JETTY_BASE/agent/skywalking-agent.jar”</p>
</li>
<li><p>webappService.sh中–collector.ribbon.listOfServers=IP1:10800,IP2:10800，IP1，IP2为相应的两个collector地址</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/monitor/%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/monitor/%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">monitor/监控命令</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-27 18:06:45" itemprop="dateModified" datetime="2019-11-27T18:06:45+08:00">2019-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>###命令大全： <a href="http://man.linuxde.net/" target="_blank" rel="noopener">http://man.linuxde.net/</a></p>
<h4 id="查看历史状态：sar"><a href="#查看历史状态：sar" class="headerlink" title="查看历史状态：sar"></a>查看历史状态：sar</h4><pre><code>cpu: cpu
内存： sar -r
 http://blog.csdn.net/sunlylorn/article/details/6215137 </code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1. sar是做什么的？</span><br><span class="line"> </span><br><span class="line">主要负责收集、汇报与存储系统运行信息的。</span><br><span class="line"> </span><br><span class="line">2. sar怎么控制信息输出的时间间隔和次数？</span><br><span class="line"> </span><br><span class="line">有两个参数非常非常常用，就是“时间间隔”和“输出次数”。</span><br><span class="line"> </span><br><span class="line">时间间隔表示两次信息输出之间的时间间隔，单位是秒。如果这个值被设置为0，则表示所输出的信息是从开机到现在为止的信息平均值。如果不是0，sar计算就都是从当前开始的信息的平均值。</span><br><span class="line"> </span><br><span class="line">输出次数表示输出系统信息的次数，默认是1次。如果这个值被设置为0，则会永远的输出下去。</span><br><span class="line"> </span><br><span class="line">比如：sar 60 5 表示每60秒输出一次，共输出5次。（如果你脑子够快的话，会发现这个命令将历时300秒，因为每一次信息输出前会先停顿60秒的。）</span><br><span class="line">http://roclinux.cn/</span><br><span class="line"></span><br><span class="line">await表示平均每次设备I/O操作的等待时间（以毫秒为单位）。 </span><br><span class="line">svctm表示平均每次设备I/O操作的服务时间（以毫秒为单位）。</span><br><span class="line">%util表示一秒中有百分之几的时间用于I/O操作。 </span><br><span class="line">对以磁盘IO性能，一般有如下评判标准：</span><br><span class="line">正常情况下svctm应该是小于await值的，而svctm的大小和磁盘性能有关，CPU、内存的负荷也会对svctm值造成影响，过多的请求也会间接的导致svctm值的增加。</span><br><span class="line">await值的大小一般取决与svctm的值和I/O队列长度以及I/O请求模式，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢，此时可以通过更换更快的硬盘来解决问题。</span><br><span class="line">%util项的值也是衡量磁盘I/O的一个重要指标，如果%util接近100%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷的在工作，该磁盘可能存在瓶颈。长期下去，势必影响系统的性能，可以通过优化程序或者通过更换更高、更快的磁盘来解决此问题。</span><br><span class="line"></span><br><span class="line">sar命令使用-n选项可以汇报网络相关信息，可用的参数包括：DEV、EDEV、SOCK和FULL。</span><br><span class="line"></span><br><span class="line">如果你使用DEV关键字，那么sar将汇报和网络设备相关的信息，如lo，eth0或eth1等，例如：</span><br><span class="line"></span><br><span class="line">IFACE：就是网络设备的名称；</span><br><span class="line">rxpck/s：每秒钟接收到的包数目</span><br><span class="line">txpck/s：每秒钟发送出去的包数目</span><br><span class="line">rxbyt/s：每秒钟接收到的字节数</span><br><span class="line">txbyt/s：每秒钟发送出去的字节数</span><br><span class="line">rxcmp/s：每秒钟接收到的压缩包数目</span><br><span class="line">txcmp/s：每秒钟发送出去的压缩包数目</span><br><span class="line">txmcst/s：每秒钟接收到的多播包的包数目</span><br><span class="line"></span><br><span class="line">来源： http://88fly.blog.163.com/blog/static/1226803902012514710581/</span><br></pre></td></tr></table></figure>

<h6 id="按进程查看流量占用-nethogs"><a href="#按进程查看流量占用-nethogs" class="headerlink" title="按进程查看流量占用: nethogs"></a>按进程查看流量占用: nethogs</h6><p>yum install nethogs</p>
<p>dstat 监控系统参数<br>yum install dstat</p>
<p>###网络<br>网络监控软件 mtr<br>mtr ip</p>
<ul>
<li>ncat<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install nmap-ncat</span><br><span class="line">监听：ncat -u -l 11940</span><br><span class="line">连接：ncat -u ip 11940  输入回车 看是否远端有同样数据打印</span><br><span class="line">http://www.jianshu.com/p/af6766e428ec</span><br><span class="line">http://www.itye.org/archives/3082</span><br></pre></td></tr></table></figure></li>
<li>nc<br>nc -uz 192.168.63.229 2249  </li>
</ul>
<p><a href="http://369369.blog.51cto.com/319630/805726/" target="_blank" rel="noopener">http://369369.blog.51cto.com/319630/805726/</a><br>iptraf<br>nload<br>yum install -y gcc* ncurses ncurses-devel</p>
<p><a href="http://man.linuxde.net/iptraf" target="_blank" rel="noopener">http://man.linuxde.net/iptraf</a></p>
<p>nethogs: 按进程查看流量占用<br>yum install nethogs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pmap 命令：查看进程用了多少内存</span><br><span class="line">怀疑CPU存在瓶颈，可用 sar -u 和 sar -q 等来查看</span><br><span class="line">怀疑内存存在瓶颈，可用sar -B、sar -r 和 sar -W 等来查看</span><br><span class="line">怀疑I/O存在瓶颈，可用 sar -b、sar -u 和 sar -d 等来查看</span><br><span class="line">http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/sar.html</span><br></pre></td></tr></table></figure>
<h4 id="cpu"><a href="#cpu" class="headerlink" title="cpu:"></a>cpu:</h4><p>vmstat 只能查看整体CPU使用情况<br>mpstat 处理相关统计信息</p>
<h3 id="io"><a href="#io" class="headerlink" title="io"></a>io</h3><p><a href="http://www.sijitao.net/1898.html" target="_blank" rel="noopener">http://www.sijitao.net/1898.html</a><br><a href="http://blog.itpub.net/29320885/viewspace-1222577/" target="_blank" rel="noopener">http://blog.itpub.net/29320885/viewspace-1222577/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rkB/s：每秒从设备读取的数据量（单位：KB）</span><br><span class="line"></span><br><span class="line">wkB/s：每秒写入设备的数据量（单位：KB）</span><br><span class="line"></span><br><span class="line">rMB/s：每秒从设备读取的数据量（单位：MB）</span><br><span class="line"></span><br><span class="line">wMB/s：每秒写入设备的数据量（单位：MB）</span><br><span class="line"></span><br><span class="line">avgrq-sz	：平均每次IO操作的数据量(扇区数为单位)</span><br><span class="line"></span><br><span class="line">avgqu-sz：平均等待处理的IO请求队列长度 </span><br><span class="line"></span><br><span class="line">await：I/O请求等待时间的平均值（单位：毫秒）</span><br><span class="line"></span><br><span class="line">svctm：I/O请求处理时间的平均值（单位：毫秒）</span><br><span class="line"></span><br><span class="line">%util：消耗在I/O请求中的CPU时间百分比（设备带宽利用率）。如果该值接近100%说明设备出现了瓶颈</span><br></pre></td></tr></table></figure>

<h3 id="disk-check"><a href="#disk-check" class="headerlink" title="disk check"></a>disk check</h3><p><a href="http://chaorenyong.blog.51cto.com/2163445/1051859/" target="_blank" rel="noopener">http://chaorenyong.blog.51cto.com/2163445/1051859/</a><br><a href="http://blog.chinaunix.net/uid-25135004-id-3139293.html" target="_blank" rel="noopener">http://blog.chinaunix.net/uid-25135004-id-3139293.html</a></p>
<h3 id="ps-vmstat-top"><a href="#ps-vmstat-top" class="headerlink" title="ps vmstat top"></a>ps vmstat top</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux看到的进程%CPU是该进程的全寿命均值,ps是从进程开始就开始算的，是平均的占用率.</span><br><span class="line">而top是从上次刷新开始算的，一般几秒钟一刷，可以认为是即时的。而桌面系统我们一般更关注即时的，所以top的cpu占用率才是我需要的。而且top默认cpu的占用率的和并不是100%，而是核数x100%，所以有时会有一个进程占用超过100%的情况。</span><br></pre></td></tr></table></figure>

<h3 id="java进程监控"><a href="#java进程监控" class="headerlink" title="java进程监控"></a>java进程监控</h3><ol>
<li><p>pstack $pid查看每个线程栈信息</p>
</li>
<li><p>jstack -l $pid</p>
</li>
<li><p>/opt/jdk1.8.0_131/bin/jstat -gcutil $pid 1000 59</p>
</li>
</ol>
<h3 id="系统进程数"><a href="#系统进程数" class="headerlink" title="系统进程数"></a>系统进程数</h3><ol start="4">
<li><p>查看线程数<code>pstree -p 14507 |wc -l</code></p>
</li>
<li><p>查看系统级线程数<code>pstree -p |wc -l</code></p>
</li>
<li><p>查看所有用户创建的进程数<code>ps h -Led -o user | sort | uniq -c | sort -n</code></p>
</li>
<li><p>查看hfds用户创建的进程数 <code>ps -o nlwp,pid,lwp,args -u hdfs | sort -n</code></p>
</li>
<li><p>查看用户级最大线程数<code>ulimit -u</code></p>
</li>
<li><p>查看当前用户进程数ps ux |wc -l</p>
</li>
<li><p>使用top命令，具体用法是 top -H</p>
<pre><code>加上这个选项，top的每一行就不是显示一个进程，而是一个线程。</code></pre></li>
<li><p>使用ps命令，具体用法是 ps -xH</p>
<pre><code>这样可以查看所有存在的线程，也可以使用grep作进一步的过滤。</code></pre></li>
<li><p>使用ps命令，具体用法是 ps -mq PID</p>
<pre><code>这样可以看到指定的进程产生的线程数目。</code></pre></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/monitor/consul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/monitor/consul/" class="post-title-link" itemprop="url">monitor/consul</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="consul"><a href="#consul" class="headerlink" title="consul"></a>consul</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./consul agent -server -bootstrap-expect=1 -data-dir=/tmp/consul -node=agent-noe -bind=10.0.0.218 -enable-script-checks=true -config-dir=/etc/consul.d</span><br><span class="line"></span><br><span class="line"> ./consul agent -data-dir=/tmp/consul -node=agent-two-bind=10.0.0.195 -enable-script-checks=true -config-dir=/etc/consul.d   -retry-join=&quot;10.0.0.218&quot;</span><br><span class="line"></span><br><span class="line">kill -HUP $&#123;consulPid&#125; #重新载入配置文件。 consul reload #重新载入配置文件</span><br><span class="line"></span><br><span class="line">使用Ctrl+C或kill -INT来gracefully停止agent./consul kv put key value</span><br><span class="line"></span><br><span class="line">./consul kv get key</span><br><span class="line"></span><br><span class="line">./consul kv delete</span><br><span class="line"></span><br><span class="line">./consul kv get -recurse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl http://localhost:8500/v1/kv/?keys</span><br><span class="line"></span><br><span class="line">curl http://localhost:8500/v1/kv/foo</span><br><span class="line"></span><br><span class="line"> curl http://localhost:8500/v1/kv/foo?raw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">put</span><br><span class="line"></span><br><span class="line">curl --request PUT --data &apos;contents&apos; http://localhost:8500/v1/kv/my-key</span><br><span class="line"></span><br><span class="line">curl --request PUT --data @contents http://localhost:8500/v1/kv/my-key</span><br><span class="line"></span><br><span class="line">curl --request DELETE http://localhost:8500/v1/kv/my-key</span><br><span class="line"></span><br><span class="line"> consul force-leave</span><br><span class="line"></span><br><span class="line">查看本机</span><br><span class="line"></span><br><span class="line">curl localhost:8500/v1/agent/services</span><br><span class="line"></span><br><span class="line">查看全局</span><br><span class="line"></span><br><span class="line">curl localhost:8500/v1/catalog/service/consul</span><br><span class="line"></span><br><span class="line">curl localhost:8500/v1/catalog/services</span><br><span class="line"></span><br><span class="line">./consul catalog services</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl \</span><br><span class="line"></span><br><span class="line">    --request PUT \</span><br><span class="line"></span><br><span class="line">    --data @payload.json \</span><br><span class="line"></span><br><span class="line">    https://consul.rocks/v1/catalog/register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -X PUT -d @./nginx.json localhost:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">curl -X PUT -d @/usr/local/proms-agent/script/conf/sys.json localhost:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">curl --request PUT  localhost:8500/v1/agent/service/deregister/nginx</span><br><span class="line"></span><br><span class="line"> curl -X PUT -d @./aa.json localhost:8500/v1/catalog/deregister</span><br></pre></td></tr></table></figure>

<p><a href="https://www.robustperception.io/finding-consul-services-to-monitor-with-prometheus/" target="_blank" rel="noopener">https://www.robustperception.io/finding-consul-services-to-monitor-with-prometheus/</a></p>
<p><a href="http://www.cnblogs.com/vovlie/p/Nginx_monitoring.html" target="_blank" rel="noopener">http://www.cnblogs.com/vovlie/p/Nginx_monitoring.html</a></p>
<p>{</p>
<p>  “ui”: true,</p>
<p>  “data_dir”: “/tmp/consul”,</p>
<p>  “client_addr”: “0.0.0.0”,</p>
<p>  “advertise_addr”: “10.0.0.218”,</p>
<p>  “server”: true,</p>
<p>  “retry_interval”: “30s”,</p>
<p>  “retry_max”: 10,</p>
<p>  “log_level”: “INFO”,</p>
<p>  “datacenter”: “sen_hua_kan_dan_qiao”,</p>
<p>  “rejoin_after_leave”: true,</p>
<p>  “leave_on_terminate”: true</p>
<p>}</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/monitor/grafana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/monitor/grafana/" class="post-title-link" itemprop="url">monitor/grafana</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-27 17:25:21" itemprop="dateModified" datetime="2019-11-27T17:25:21+08:00">2019-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>datasource prometheus</p>
<p>根据变量复制面板Row：row options -&gt; repeat for</p>
<p>根据变量复制面板panel：repeat pannel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">io_util&#123;job=&quot;[[job]]&quot;, group=&quot;[[group]]&quot;,instance=~&quot;^[[hosts]]&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>升级新版本</p>
<p>yum update /home/xujingbin/grafana-5.1.3-1.x86_64.rpm</p>
<p>/etc/init.d/grafana-server restart</p>
<p><a href="http://docs.grafana.org/reference/templating/" target="_blank" rel="noopener">http://docs.grafana.org/reference/templating/</a></p>
<p>告警模板<br><a href="https://grafana.com/grafana/dashboards?dataSource=camptocamp-prometheus-alertmanager-datasource" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards?dataSource=camptocamp-prometheus-alertmanager-datasource</a></p>
<h1 id="grafana权限"><a href="#grafana权限" class="headerlink" title="grafana权限"></a>grafana权限</h1><p><a href="https://blog.csdn.net/liukuan73/article/details/78704395" target="_blank" rel="noopener">https://blog.csdn.net/liukuan73/article/details/78704395</a></p>
<p>经过上面的操作，就将组织和用户进行了划分，然后在每个组织内新建数据源、DashBoard，这样，不同的用户属于不同的组织，不同的组织拥有独立的数据源以及DashBoard，就实现了多租户功能。</p>
<p>由于数据源、 DashBoard是和组织关联的，因此没法做到一个组织内不同的用户，看到不同的DashBoard，不过Grafana新建组织，已经可以满足大部分需求了，比如有多个数据中心时，只要建立不同的数据中心组织，配上相应的数据源，就可以使用一套Grafana来展现了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/16/monitor/prometheus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xujingbin">
      <meta itemprop="description" content="个人运维笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="运维笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/monitor/prometheus/" class="post-title-link" itemprop="url">monitor/prometheus</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-16 10:31:09" itemprop="dateCreated datePublished" datetime="2019-07-16T10:31:09+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-27 17:24:42" itemprop="dateModified" datetime="2019-11-27T17:24:42+08:00">2019-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Prometheus的架构及持久化"><a href="#Prometheus的架构及持久化" class="headerlink" title="Prometheus的架构及持久化"></a><a href="https://segmentfault.com/a/1190000008629939" target="_blank" rel="noopener">Prometheus的架构及持久化</a></h3><h3 id="Prometheus-github"><a href="#Prometheus-github" class="headerlink" title="Prometheus github"></a><a href="https://github.com/prometheus/" target="_blank" rel="noopener">Prometheus github</a></h3><h2 id="kubernetes监控告警详解"><a href="#kubernetes监控告警详解" class="headerlink" title="kubernetes监控告警详解"></a><a href="https://blog.csdn.net/hxpjava1/article/details/80362563" target="_blank" rel="noopener">kubernetes监控告警详解</a></h2><h2 id="https-www-robustperception-io-relabel-configs-vs-metric-relabel-configs"><a href="#https-www-robustperception-io-relabel-configs-vs-metric-relabel-configs" class="headerlink" title="https://www.robustperception.io/relabel_configs-vs-metric_relabel_configs"></a><a href="https://www.robustperception.io/relabel_configs-vs-metric_relabel_configs" target="_blank" rel="noopener">https://www.robustperception.io/relabel_configs-vs-metric_relabel_configs</a></h2><h3 id="Prometheus-和-Grafana-监控系统指南"><a href="#Prometheus-和-Grafana-监控系统指南" class="headerlink" title="Prometheus 和 Grafana 监控系统指南"></a><a href="https://blog.eood.cn/prometheus-grafana-monitoring" target="_blank" rel="noopener">Prometheus 和 Grafana 监控系统指南</a></h3><ol>
<li><p>Prometheus 的查询系统</p>
</li>
<li><p>这些信息分两种，一种是状态信息</p>
</li>
<li><p>另外一种是累加值信息，比如 haproxy_backend_http_responses_total</p>
</li>
</ol>
<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><p>Prometheus以scrape_interval（默认为1m）规则周期，从监控目标上收集信息。其中scrape_interval可以基于全局或基于单个metric定义；然后将监控信息持久存储在其本地存储上。<br>Prometheus以evaluation_interval（默认为1m）另一个独立的规则周期，对告警规则做定期计算。其中evaluation_interval只有全局值；然后更新告警状态。</p>
<h3 id="启动指令"><a href="#启动指令" class="headerlink" title="启动指令"></a>启动指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/usr/local/go/src/github.com/prometheus/prometheus/prometheus --config.file=prometheus.yml -alertmanager.url=http://42.62.2.194:9093/ -storage.local.retention 720h0m0s &amp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./alertmanager --config.file=alertmanager.yml &amp;</span><br><span class="line"></span><br><span class="line">gprp91 haproxy收集端</span><br><span class="line">nohup ./haproxy_exporter --haproxy.scrape-uri=unix:/tmp/haproxy.socket1 &amp;</span><br></pre></td></tr></table></figure>



<h3 id="报错解决"><a href="#报错解决" class="headerlink" title="报错解决"></a>报错解决</h3><p>context deadline exceeded</p>
<p>抓取超时</p>
<h3 id="pushgateway"><a href="#pushgateway" class="headerlink" title="pushgateway"></a>pushgateway</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - job_name: &apos;pushgateway&apos;</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line"></span><br><span class="line">    - targets: [&apos;192.168.62.140:9091&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python sys.py |curl --data-binary @- http://localhost:9091/metrics/job/sys/instance/node2</span><br></pre></td></tr></table></figure>

<h2 id="删除指标"><a href="#删除指标" class="headerlink" title="删除指标"></a>删除指标</h2><p><a href="https://blog.51cto.com/lee90/2394989" target="_blank" rel="noopener">https://blog.51cto.com/lee90/2394989</a></p>
<ol>
<li>确保 prometheus 启动的时候， 加了参数  –web.enable-admin-api<br><code>./prometheus --storage.tsdb.retention=180d --web.enable-admin-api</code></li>
<li>清理这个key的全部的数据<br><code>curl -X POST \
-g &#39;http://192.168.2.100:9090/api/v1/admin/tsdb/delete_series?match[]=up&amp;match[]=mysql_global_status_threads_running{instance=&quot;test-db13:9104&quot;,job=&quot;mysql&quot;}&#39;</code></li>
<li>清理这个key指定时间段的数据 （清理的时间戳区间：1557903714 到 155790395 ）<br><code>curl -X POST \
-g &#39;http://192.168.2.100:9090/api/v1/admin/tsdb/delete_series?start=1557903714&amp;end=1557903954&amp;match[]=mysql_global_status_threads_running{instance=&quot;test-db13:9104&quot;,job=&quot;mysql&quot;}&#39;</code></li>
</ol>
<h2 id="百分位"><a href="#百分位" class="headerlink" title="百分位"></a>百分位</h2><p>Prometheus中称为quantile，其实叫percentile更准确。百分位数是指小于某个特定数值的采样点达到一定的百分比。例如，假设0.9-quantile的值为120，意思就是所有的采样值中，小于120的采样值的数量占总体采样值的90%。相应的，假设0.5-quantile的值为x，那么意思就是指小于x的采样值占总体的50%，所以0.5-quantile也指中值（median）。</p>
<h2 id="阿里云prometheus修改配置规则"><a href="#阿里云prometheus修改配置规则" class="headerlink" title="阿里云prometheus修改配置规则"></a>阿里云prometheus修改配置规则</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n monitoring get prometheusrule</span><br><span class="line">更改prometheus到alermanager的地址在，阿里云控制台的容器服务-应用-发布-更新</span><br><span class="line">1340行:</span><br><span class="line">additionalAlertManagerConfigs:</span><br><span class="line">- static_configs:</span><br><span class="line"> - targets: [&quot;10.28.74.182:9093&quot;]</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xujingbin</p>
  <div class="site-description" itemprop="description">个人运维笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xujingbin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.5.0
  </div>

        








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

</body>
</html>
